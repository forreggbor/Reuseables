/**
 * WYSIWYGEditor - Lightweight rich text editor without external dependencies
 *
 * A simple, customizable WYSIWYG editor that transforms a textarea into a rich text editor
 * using native browser APIs (contenteditable, execCommand).
 *
 * @package WYSIWYGEditor
 * @version 2.2.2
 * @license MIT
 */
class WYSIWYGEditor{static stylesInjected=!1;static defaults={toolbar:["bold","italic","underline","strikethrough","subscript","superscript","|","fontSize","fontName","|","textColor","bgColor","|","h1","h2","h3","h4","h5","h6","|","ul","ol","blockquote","pre","|","link","unlink","|","alignLeft","alignCenter","alignRight","justifyFull","|","indent","outdent","|","hr","table","image","|","undo","redo","|","clearFormat","codeView"],placeholder:"",pasteAsPlainText:!1,minHeight:"200px",maxHeight:null,onChange:null,onFocus:null,onBlur:null,shortcuts:!0,classPrefix:"wysiwyg",linkTargetBlank:!0,fontSizes:["12px","14px","16px","18px","20px","24px","32px","48px"],fontFamilies:[{label:"Arial",value:"Arial, sans-serif"},{label:"Times New Roman",value:'"Times New Roman", serif'},{label:"Georgia",value:"Georgia, serif"},{label:"Courier New",value:'"Courier New", monospace'},{label:"Verdana",value:"Verdana, sans-serif"},{label:"Trebuchet MS",value:'"Trebuchet MS", sans-serif'}],colorPalette:["#000000","#434343","#666666","#999999","#cccccc","#ffffff","#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#0000ff","#9900ff","#ff00ff","#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],tableDefaults:{rows:3,cols:3},imageUpload:!0,maxImageSize:5242880,allowedImageTypes:["image/jpeg","image/png","image/gif","image/webp"]};static toolbarButtons={bold:{icon:"<b>B</b>",title:"Bold (Ctrl+B)",command:"bold"},italic:{icon:"<i>I</i>",title:"Italic (Ctrl+I)",command:"italic"},underline:{icon:"<u>U</u>",title:"Underline (Ctrl+U)",command:"underline"},strikethrough:{icon:"<s>S</s>",title:"Strikethrough",command:"strikeThrough"},subscript:{icon:"X<sub>2</sub>",title:"Subscript",command:"subscript",custom:!0},superscript:{icon:"X<sup>2</sup>",title:"Superscript",command:"superscript",custom:!0},h1:{icon:"H1",title:"Heading 1",command:"formatBlock",value:"h1"},h2:{icon:"H2",title:"Heading 2",command:"formatBlock",value:"h2"},h3:{icon:"H3",title:"Heading 3",command:"formatBlock",value:"h3"},h4:{icon:"H4",title:"Heading 4",command:"formatBlock",value:"h4"},h5:{icon:"H5",title:"Heading 5",command:"formatBlock",value:"h5"},h6:{icon:"H6",title:"Heading 6",command:"formatBlock",value:"h6"},blockquote:{icon:"&#8220;",title:"Block Quote",command:"formatBlock",value:"blockquote"},pre:{icon:"&#9001;/&#9002;",title:"Preformatted Block",command:"formatBlock",value:"pre"},ul:{icon:"&#8226;",title:"Bullet List",command:"insertUnorderedList"},ol:{icon:"1.",title:"Numbered List",command:"insertOrderedList"},hr:{icon:"&#8213;",title:"Horizontal Rule",command:"insertHorizontalRule"},link:{icon:"&#128279;",title:"Insert Link (Ctrl+K)",command:"link",custom:!0},unlink:{icon:"&#10060;",title:"Remove Link",command:"unlink"},alignLeft:{icon:"&#8676;",title:"Align Left",command:"justifyLeft"},alignCenter:{icon:"&#8596;",title:"Align Center",command:"justifyCenter"},alignRight:{icon:"&#8677;",title:"Align Right",command:"justifyRight"},justifyFull:{icon:"&#9776;",title:"Justify",command:"justifyFull"},indent:{icon:"&#8680;",title:"Increase Indent",command:"indent",custom:!0},outdent:{icon:"&#8678;",title:"Decrease Indent",command:"outdent",custom:!0},undo:{icon:"&#8617;",title:"Undo (Ctrl+Z)",command:"undo"},redo:{icon:"&#8618;",title:"Redo (Ctrl+Y)",command:"redo"},clearFormat:{icon:"T&#824;",title:"Clear Formatting",command:"removeFormat",custom:!0},fontSize:{icon:"A<small>&#9662;</small>",title:"Font Size",command:"fontSize",custom:!0,type:"dropdown"},fontName:{icon:"F<small>&#9662;</small>",title:"Font Family",command:"fontName",custom:!0,type:"dropdown"},textColor:{icon:'<span style="border-bottom:3px solid #000">A</span>',title:"Text Color",command:"foreColor",custom:!0,type:"colorPicker"},bgColor:{icon:'<span style="background:#ff0;padding:0 2px">A</span>',title:"Background Color",command:"backColor",custom:!0,type:"colorPicker"},table:{icon:"&#9638;",title:"Insert Table",command:"insertTable",custom:!0},image:{icon:"&#128247;",title:"Insert Image",command:"insertImage",custom:!0},codeView:{icon:"&lt;/&gt;",title:"View HTML Source",command:"codeView",custom:!0},"|":{type:"separator"}};static styles="\n        .wysiwyg-wrapper {\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            overflow: hidden;\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n        }\n        .wysiwyg-toolbar {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 2px;\n            padding: 8px;\n            background: #f5f5f5;\n            border-bottom: 1px solid #ddd;\n        }\n        .wysiwyg-btn {\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            min-width: 32px;\n            height: 32px;\n            padding: 4px 8px;\n            border: 1px solid transparent;\n            border-radius: 4px;\n            background: transparent;\n            cursor: pointer;\n            font-size: 14px;\n            color: #333;\n            transition: background-color 0.15s, border-color 0.15s;\n        }\n        .wysiwyg-btn:hover {\n            background: #e0e0e0;\n            border-color: #ccc;\n        }\n        .wysiwyg-btn:active {\n            background: #d0d0d0;\n        }\n        .wysiwyg-btn-active {\n            background: #d0d0d0;\n            border-color: #999;\n        }\n        .wysiwyg-btn-disabled {\n            opacity: 0.4;\n            pointer-events: none;\n        }\n        .wysiwyg-separator {\n            display: inline-block;\n            width: 1px;\n            height: 24px;\n            margin: 4px 6px;\n            background: #ccc;\n        }\n        .wysiwyg-editor {\n            position: relative;\n            padding: 12px;\n            min-height: 200px;\n            outline: none;\n            overflow-y: auto;\n            background: #fff;\n            line-height: 1.6;\n        }\n        .wysiwyg-editor:empty:before {\n            content: attr(data-placeholder);\n            color: #999;\n            pointer-events: none;\n        }\n        .wysiwyg-editor p {\n            margin: 0 0 1em 0;\n        }\n        .wysiwyg-editor p:last-child {\n            margin-bottom: 0;\n        }\n        .wysiwyg-editor h1, .wysiwyg-editor h2, .wysiwyg-editor h3 {\n            margin: 0 0 0.5em 0;\n            line-height: 1.3;\n        }\n        .wysiwyg-editor h1 { font-size: 2em; }\n        .wysiwyg-editor h2 { font-size: 1.5em; }\n        .wysiwyg-editor h3 { font-size: 1.17em; }\n        .wysiwyg-editor ul, .wysiwyg-editor ol {\n            margin: 0 0 1em 0;\n            padding-left: 2em;\n        }\n        .wysiwyg-editor a {\n            color: #0066cc;\n            text-decoration: underline;\n        }\n        .wysiwyg-editor a:hover {\n            color: #004499;\n        }\n        .wysiwyg-editor table {\n            border-collapse: collapse;\n            width: 100%;\n            margin: 1em 0;\n        }\n        .wysiwyg-editor td, .wysiwyg-editor th {\n            border: 1px solid #ccc;\n            padding: 8px;\n            min-width: 40px;\n        }\n        .wysiwyg-table-selected {\n            outline: 2px solid #007bff;\n            outline-offset: 2px;\n        }\n        .wysiwyg-table-toolbar {\n            position: absolute;\n            z-index: 1000;\n            background: #fff;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n            padding: 4px;\n            display: flex;\n            gap: 2px;\n            flex-wrap: wrap;\n            max-width: 320px;\n        }\n        .wysiwyg-table-toolbar-btn {\n            background: #f5f5f5;\n            border: 1px solid #ddd;\n            border-radius: 3px;\n            padding: 4px 8px;\n            font-size: 12px;\n            cursor: pointer;\n            white-space: nowrap;\n        }\n        .wysiwyg-table-toolbar-btn:hover {\n            background: #e0e0e0;\n        }\n        .wysiwyg-table-toolbar-separator {\n            width: 1px;\n            background: #ddd;\n            margin: 0 4px;\n        }\n        .wysiwyg-editor img {\n            max-width: 100%;\n            height: auto;\n        }\n        .wysiwyg-code-editor {\n            width: 100%;\n            min-height: 200px;\n            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\n            font-size: 13px;\n            line-height: 1.5;\n            border: none;\n            padding: 12px;\n            resize: vertical;\n            box-sizing: border-box;\n            outline: none;\n            background: #fff;\n        }\n        .wysiwyg-dropdown-wrapper {\n            position: relative;\n            display: inline-block;\n        }\n        .wysiwyg-dropdown {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            z-index: 1000;\n            min-width: 120px;\n            max-height: 300px;\n            overflow-y: auto;\n            background: #fff;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n            display: none;\n        }\n        .wysiwyg-dropdown-open {\n            display: block;\n        }\n        .wysiwyg-dropdown-item {\n            padding: 8px 12px;\n            cursor: pointer;\n            white-space: nowrap;\n        }\n        .wysiwyg-dropdown-item:hover {\n            background: #f0f0f0;\n        }\n        .wysiwyg-color-picker {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            z-index: 1000;\n            padding: 8px;\n            background: #fff;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n            display: none;\n        }\n        .wysiwyg-color-picker-open {\n            display: grid;\n            grid-template-columns: repeat(6, 24px);\n            gap: 4px;\n        }\n        .wysiwyg-color-swatch {\n            width: 24px;\n            height: 24px;\n            border: 1px solid #ccc;\n            border-radius: 2px;\n            cursor: pointer;\n            box-sizing: border-box;\n        }\n        .wysiwyg-color-swatch:hover {\n            border-color: #333;\n            transform: scale(1.1);\n        }\n        .wysiwyg-color-remove {\n            grid-column: span 6;\n            text-align: center;\n            padding: 4px;\n            cursor: pointer;\n            border-top: 1px solid #eee;\n            margin-top: 4px;\n            font-size: 12px;\n            color: #666;\n        }\n        .wysiwyg-color-remove:hover {\n            background: #f0f0f0;\n        }\n        .wysiwyg-modal-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0,0,0,0.5);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        }\n        .wysiwyg-modal {\n            position: relative;\n            z-index: 10001;\n            background: #fff;\n            border-radius: 8px;\n            padding: 20px;\n            min-width: 300px;\n            max-width: 90vw;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n        }\n        .wysiwyg-modal-header {\n            font-size: 18px;\n            font-weight: 600;\n            margin-bottom: 16px;\n        }\n        .wysiwyg-modal-body {\n            margin-bottom: 16px;\n        }\n        .wysiwyg-modal-footer {\n            display: flex;\n            justify-content: flex-end;\n            gap: 8px;\n        }\n        .wysiwyg-modal-row {\n            margin-bottom: 12px;\n        }\n        .wysiwyg-modal-label {\n            display: block;\n            margin-bottom: 4px;\n            font-weight: 500;\n            font-size: 14px;\n        }\n        .wysiwyg-modal-input {\n            display: block;\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            font-size: 14px;\n            box-sizing: border-box;\n            position: relative;\n            z-index: 1;\n        }\n        .wysiwyg-modal-input:focus {\n            outline: none;\n            border-color: #007bff;\n        }\n        .wysiwyg-modal-btn {\n            padding: 8px 16px;\n            border: none;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 14px;\n        }\n        .wysiwyg-modal-btn-primary {\n            background: #007bff;\n            color: #fff;\n        }\n        .wysiwyg-modal-btn-primary:hover {\n            background: #0056b3;\n        }\n        .wysiwyg-modal-btn-secondary {\n            background: #e0e0e0;\n            color: #333;\n        }\n        .wysiwyg-modal-btn-secondary:hover {\n            background: #d0d0d0;\n        }\n        .wysiwyg-modal-tabs {\n            display: flex;\n            border-bottom: 1px solid #ccc;\n            margin-bottom: 16px;\n        }\n        .wysiwyg-modal-tab {\n            padding: 8px 16px;\n            cursor: pointer;\n            border-bottom: 2px solid transparent;\n            margin-bottom: -1px;\n        }\n        .wysiwyg-modal-tab:hover {\n            background: #f5f5f5;\n        }\n        .wysiwyg-modal-tab-active {\n            border-bottom-color: #007bff;\n            color: #007bff;\n        }\n        .wysiwyg-modal-tab-content {\n            display: none;\n        }\n        .wysiwyg-modal-tab-content-active {\n            display: block;\n        }\n        .wysiwyg-image-selected {\n            outline: 2px solid #007bff;\n            outline-offset: 2px;\n            cursor: pointer;\n        }\n        .wysiwyg-image-toolbar {\n            position: absolute;\n            z-index: 1000;\n            background: #fff;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n            padding: 4px;\n            display: flex;\n            gap: 4px;\n        }\n        .wysiwyg-image-toolbar-btn {\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            width: 28px;\n            height: 28px;\n            border: 1px solid #ccc;\n            border-radius: 4px;\n            background: #fff;\n            cursor: pointer;\n            font-size: 12px;\n        }\n        .wysiwyg-image-toolbar-btn:hover {\n            background: #f0f0f0;\n        }\n        .wysiwyg-image-resizer {\n            position: absolute;\n            z-index: 999;\n            border: 1px dashed #007bff;\n            pointer-events: none;\n        }\n        .wysiwyg-image-handle {\n            position: absolute;\n            width: 10px;\n            height: 10px;\n            background: #007bff;\n            border: 1px solid #fff;\n            pointer-events: all;\n        }\n        .wysiwyg-image-handle-se {\n            right: -5px;\n            bottom: -5px;\n            cursor: se-resize;\n        }\n        .wysiwyg-image-handle-sw {\n            left: -5px;\n            bottom: -5px;\n            cursor: sw-resize;\n        }\n        .wysiwyg-image-handle-ne {\n            right: -5px;\n            top: -5px;\n            cursor: ne-resize;\n        }\n        .wysiwyg-image-handle-nw {\n            left: -5px;\n            top: -5px;\n            cursor: nw-resize;\n        }\n    ";textarea;config;wrapper;toolbar;editor;codeEditor;isCodeView=!1;savedSelection=null;documentClickHandler=null;selectedImage=null;imageToolbar=null;imageResizer=null;
/**
     * Create a new WYSIWYGEditor instance
     *
     * @param {HTMLTextAreaElement|string} textarea - Textarea element or selector
     * @param {Object} options - Configuration options
     */
constructor(e,t={}){if("string"==typeof e&&(e=document.querySelector(e)),!e||"TEXTAREA"!==e.tagName)throw new Error("WYSIWYGEditor requires a textarea element");this.textarea=e,this.config={...WYSIWYGEditor.defaults,...t},this.config.toolbar.includes("all")&&(this.config.toolbar=[...WYSIWYGEditor.defaults.toolbar]),this.init()}init(){WYSIWYGEditor.injectStyles(this.config.classPrefix),this.buildWrapper(),this.buildToolbar(),this.buildEditor(),this.buildCodeEditor(),this.bindEvents(),this.textarea.value&&(this.editor.innerHTML=this.sanitizeEditorUI(this.textarea.value))}static injectStyles(e="wysiwyg"){if(WYSIWYGEditor.stylesInjected)return;const t=document.createElement("style");t.id="wysiwyg-editor-styles",t.textContent=WYSIWYGEditor.styles.replace(/\.wysiwyg-/g,`.${e}-`),document.head.appendChild(t),WYSIWYGEditor.stylesInjected=!0}buildWrapper(){this.wrapper=document.createElement("div"),this.wrapper.className=`${this.config.classPrefix}-wrapper`,this.textarea.parentNode.insertBefore(this.wrapper,this.textarea),this.textarea.style.display="none"}buildToolbar(){this.toolbar=document.createElement("div"),this.toolbar.className=`${this.config.classPrefix}-toolbar`,this.config.toolbar.forEach(e=>{const t=WYSIWYGEditor.toolbarButtons[e];if(!t)return;if("|"===e||"separator"===t.type){const e=document.createElement("span");return e.className=`${this.config.classPrefix}-separator`,void this.toolbar.appendChild(e)}if("dropdown"===t.type){const o=this.createDropdownButton(e,t);return void this.toolbar.appendChild(o)}if("colorPicker"===t.type){const o=this.createColorPickerButton(e,t);return void this.toolbar.appendChild(o)}const o=document.createElement("button");o.type="button",o.className=`${this.config.classPrefix}-btn`,o.dataset.command=t.command,t.value&&(o.dataset.value=t.value),t.custom&&(o.dataset.custom="true"),o.title=t.title,o.innerHTML=t.icon,this.toolbar.appendChild(o)}),this.wrapper.appendChild(this.toolbar)}buildEditor(){this.editor=document.createElement("div"),this.editor.className=`${this.config.classPrefix}-editor`,this.editor.contentEditable="true",document.execCommand("defaultParagraphSeparator",!1,"p"),this.config.placeholder&&(this.editor.dataset.placeholder=this.config.placeholder),this.config.minHeight&&(this.editor.style.minHeight=this.config.minHeight),this.config.maxHeight&&(this.editor.style.maxHeight=this.config.maxHeight),this.wrapper.appendChild(this.editor)}buildCodeEditor(){this.codeEditor=document.createElement("textarea"),this.codeEditor.className=`${this.config.classPrefix}-code-editor`,this.codeEditor.style.display="none",this.config.minHeight&&(this.codeEditor.style.minHeight=this.config.minHeight),this.config.maxHeight&&(this.codeEditor.style.maxHeight=this.config.maxHeight),this.wrapper.appendChild(this.codeEditor)}createDropdownButton(e,t){const o=this.config.classPrefix,n=document.createElement("div");n.className=`${o}-dropdown-wrapper`;const i=document.createElement("button");i.type="button",i.className=`${o}-btn`,i.dataset.command=t.command,i.dataset.custom="true",i.dataset.dropdownTrigger=e,i.title=t.title,i.innerHTML=t.icon;const a=document.createElement("div");return a.className=`${o}-dropdown`,a.dataset.dropdown=e,"fontSize"===e?this.config.fontSizes.forEach(e=>{const t=document.createElement("div");t.className=`${o}-dropdown-item`,t.dataset.value=e,t.textContent=e,t.style.fontSize=e,a.appendChild(t)}):"fontName"===e&&this.config.fontFamilies.forEach(e=>{const t=document.createElement("div");t.className=`${o}-dropdown-item`,t.dataset.value=e.value,t.textContent=e.label,t.style.fontFamily=e.value,a.appendChild(t)}),n.appendChild(i),n.appendChild(a),n}createColorPickerButton(e,t){const o=this.config.classPrefix,n=document.createElement("div");n.className=`${o}-dropdown-wrapper`;const i=document.createElement("button");i.type="button",i.className=`${o}-btn`,i.dataset.command=t.command,i.dataset.custom="true",i.dataset.colorPickerTrigger=e,i.title=t.title,i.innerHTML=t.icon;const a=document.createElement("div");if(a.className=`${o}-color-picker`,a.dataset.colorPicker=e,this.config.colorPalette.forEach(e=>{const t=document.createElement("div");t.className=`${o}-color-swatch`,t.style.backgroundColor=e,t.dataset.color=e,t.title=e,a.appendChild(t)}),"bgColor"===e){const e=document.createElement("div");e.className=`${o}-color-remove`,e.dataset.color="transparent",e.textContent="Remove",a.appendChild(e)}return n.appendChild(i),n.appendChild(a),n}bindEvents(){const e=this.config.classPrefix;this.toolbar.addEventListener("click",t=>{const o=t.target.closest("[data-dropdown-trigger]");if(o)return t.preventDefault(),t.stopPropagation(),this.saveSelection(),void this.toggleDropdown(o.dataset.dropdownTrigger);const n=t.target.closest(`.${e}-dropdown-item`);if(n){t.preventDefault(),t.stopPropagation();const o=n.closest(`.${e}-dropdown`).dataset.dropdown,i=n.dataset.value;return void this.handleDropdownSelect(o,i)}const i=t.target.closest("[data-color-picker-trigger]");if(i)return t.preventDefault(),t.stopPropagation(),this.saveSelection(),void this.toggleColorPicker(i.dataset.colorPickerTrigger);const a=t.target.closest(`.${e}-color-swatch, .${e}-color-remove`);if(a){t.preventDefault(),t.stopPropagation();const o=a.closest(`.${e}-color-picker`).dataset.colorPicker,n=a.dataset.color;return void this.handleColorSelect(o,n)}const s=t.target.closest("[data-command]");s&&(t.preventDefault(),"true"===s.dataset.custom?this.handleCustomCommand(s.dataset.command):this.exec(s.dataset.command,s.dataset.value||null))}),this.editor.addEventListener("input",()=>{this.sync(),this.config.onChange&&this.config.onChange(this.getContent())}),this.codeEditor.addEventListener("input",()=>{this.config.onChange&&this.config.onChange(this.codeEditor.value)}),this.editor.addEventListener("keydown",e=>this.handleKeyboard(e)),this.editor.addEventListener("paste",e=>this.handlePaste(e)),this.editor.addEventListener("focus",()=>{this.config.onFocus&&this.config.onFocus()}),this.editor.addEventListener("blur",()=>{this.config.onBlur&&this.config.onBlur()}),document.addEventListener("selectionchange",()=>{this.editor.contains(document.getSelection().anchorNode)&&this.updateToolbarState()}),this.editor.addEventListener("click",e=>{const t=this.config.classPrefix;if("IMG"===e.target.tagName)e.preventDefault(),this.selectImage(e.target),this.deselectTable();else if(e.target.closest("table")){const o=e.target.closest("table"),n=e.target.closest("td, th");e.target.closest(`.${t}-table-toolbar`)||(this.selectTable(o,n),this.deselectImage())}else e.target.closest(`.${t}-image-toolbar`)||this.deselectImage(),e.target.closest(`.${t}-table-toolbar`)||this.deselectTable()}),this.documentClickHandler=e=>{this.wrapper.contains(e.target)||(this.closeAllPopups(),this.deselectImage(),this.deselectTable())},document.addEventListener("click",this.documentClickHandler);const t=this.textarea.closest("form");t&&t.addEventListener("submit",()=>this.sync())}exec(e,t=null){if(this.editor.focus(),"formatBlock"===e&&t){document.queryCommandValue("formatBlock").toLowerCase()===t.toLowerCase()?document.execCommand(e,!1,"<p>"):document.execCommand(e,!1,`<${t}>`)}else document.execCommand(e,!1,t);this.sync(),this.updateToolbarState()}handleCustomCommand(e){switch(e){case"link":this.insertLink();break;case"codeView":this.toggleCodeView();break;case"insertTable":this.showTableModal();break;case"insertImage":this.showImageModal();break;case"subscript":this.toggleSubscript();break;case"superscript":this.toggleSuperscript();break;case"indent":this.applyIndent();break;case"outdent":this.applyOutdent();break;case"removeFormat":this.safeRemoveFormat()}}toggleSubscript(){this.editor.focus(),this.isInsideTag("sup")&&document.execCommand("superscript",!1,null),document.execCommand("subscript",!1,null),this.sync(),this.updateToolbarState()}toggleSuperscript(){this.editor.focus(),this.isInsideTag("sub")&&document.execCommand("subscript",!1,null),document.execCommand("superscript",!1,null),this.sync(),this.updateToolbarState()}isInsideTag(e){const t=window.getSelection();if(!t.rangeCount)return!1;let o=t.anchorNode;for(;o&&o!==this.editor;){if(o.nodeType===Node.ELEMENT_NODE&&o.tagName.toLowerCase()===e)return!0;o=o.parentNode}return!1}getSelectedBlockElement(){const e=window.getSelection();if(!e.rangeCount)return null;let t=e.anchorNode;t.nodeType===Node.TEXT_NODE&&(t=t.parentElement);const o=["P","DIV","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","PRE","LI","TD","TH"];for(;t&&t!==this.editor;){if(t.nodeType===Node.ELEMENT_NODE&&o.includes(t.tagName))return t;t=t.parentNode}return null}applyIndent(){this.editor.focus();const e=this.getSelectedBlockElement();if(!e)return;const t=parseInt(getComputedStyle(e).marginLeft,10)||0;e.style.marginLeft=t+40+"px",this.sync(),this.updateToolbarState()}applyOutdent(){this.editor.focus();const e=this.getSelectedBlockElement();if(!e)return;const t=parseInt(getComputedStyle(e).marginLeft,10)||0,o=Math.max(0,t-40);0===o?(e.style.marginLeft="",e.getAttribute("style")?.trim()||e.removeAttribute("style")):e.style.marginLeft=o+"px",this.sync(),this.updateToolbarState()}safeRemoveFormat(){this.editor.focus();const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),o=t.commonAncestorContainer,n=o.nodeType===Node.TEXT_NODE?o.parentElement:o,i=[];if((n.querySelectorAll?n.querySelectorAll("a[href]"):[]).forEach(e=>{t.intersectsNode(e)&&i.push({href:e.href,target:e.target,textContent:e.textContent})}),document.execCommand("removeFormat",!1,null),i.length>0){this.editor.innerHTML;i.forEach(e=>{e.textContent.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(!this.editor.querySelector(`a[href="${CSS.escape(e.href)}"]`)){const t=document.createTreeWalker(this.editor,NodeFilter.SHOW_TEXT,null);for(;t.nextNode();){const o=t.currentNode;if(o.textContent.includes(e.textContent)){const t=document.createElement("a");t.href=e.href,e.target&&(t.target=e.target),t.textContent=e.textContent,o.parentNode.replaceChild(t,o);break}}}})}this.sync(),this.updateToolbarState()}insertLink(){const e=window.getSelection().toString().length>0,t=prompt("Enter URL:","https://");if(t&&"https://"!==t){if(this.editor.focus(),e){if(document.execCommand("createLink",!1,t),this.config.linkTargetBlank){this.editor.querySelectorAll(`a[href="${t}"]`).forEach(e=>{e.target||(e.target="_blank",e.rel="noopener noreferrer")})}}else{const e=this.config.linkTargetBlank?`<a href="${this.escapeHtml(t)}" target="_blank" rel="noopener noreferrer">${this.escapeHtml(t)}</a>`:`<a href="${this.escapeHtml(t)}">${this.escapeHtml(t)}</a>`;document.execCommand("insertHTML",!1,e)}this.sync()}}saveSelection(){const e=window.getSelection();e.rangeCount>0&&(this.savedSelection=e.getRangeAt(0).cloneRange())}restoreSelection(){if(this.savedSelection){const e=window.getSelection();e.removeAllRanges(),e.addRange(this.savedSelection)}this.editor.focus()}toggleDropdown(e){const t=this.config.classPrefix,o=this.toolbar.querySelector(`[data-dropdown="${e}"]`);if(!o)return;const n=o.classList.contains(`${t}-dropdown-open`);this.closeAllPopups(),n||o.classList.add(`${t}-dropdown-open`)}toggleColorPicker(e){const t=this.config.classPrefix,o=this.toolbar.querySelector(`[data-color-picker="${e}"]`);if(!o)return;const n=o.classList.contains(`${t}-color-picker-open`);this.closeAllPopups(),n||o.classList.add(`${t}-color-picker-open`)}handleDropdownSelect(e,t){this.closeAllPopups(),this.restoreSelection(),"fontSize"===e?this.applyFontSize(t):"fontName"===e&&document.execCommand("fontName",!1,t),this.sync(),this.updateToolbarState()}applyFontSize(e){const t=window.getSelection();if(!t.rangeCount)return;const o=t.getRangeAt(0);if(o.collapsed){const n=document.createElement("span");n.style.fontSize=e,n.innerHTML="&#8203;",o.insertNode(n),o.setStart(n.firstChild,1),o.setEnd(n.firstChild,1),t.removeAllRanges(),t.addRange(o)}else{const n=document.createElement("span");n.style.fontSize=e;try{o.surroundContents(n)}catch(e){const t=o.extractContents();n.appendChild(t),o.insertNode(n)}o.selectNodeContents(n),t.removeAllRanges(),t.addRange(o)}}handleColorSelect(e,t){this.closeAllPopups(),this.restoreSelection(),"textColor"===e?document.execCommand("foreColor",!1,t):"bgColor"===e&&("transparent"===t?document.execCommand("removeFormat",!1,null):document.execCommand("backColor",!1,t)),this.sync(),this.updateToolbarState()}closeAllPopups(){const e=this.config.classPrefix;this.toolbar.querySelectorAll(`.${e}-dropdown-open`).forEach(t=>{t.classList.remove(`${e}-dropdown-open`)}),this.toolbar.querySelectorAll(`.${e}-color-picker-open`).forEach(t=>{t.classList.remove(`${e}-color-picker-open`)})}toggleCodeView(){const e=this.config.classPrefix;this.isCodeView=!this.isCodeView,this.isCodeView?(this.deselectImage(),this.deselectTable(),this.codeEditor.value=this.getCleanContent(),this.editor.style.display="none",this.codeEditor.style.display="block",this.codeEditor.focus(),this.toolbar.querySelectorAll(`.${e}-btn`).forEach(t=>{"codeView"!==t.dataset.command?t.classList.add(`${e}-btn-disabled`):t.classList.add(`${e}-btn-active`)})):(this.editor.innerHTML=this.sanitizeEditorUI(this.codeEditor.value),this.codeEditor.style.display="none",this.editor.style.display="block",this.editor.focus(),this.sync(),this.toolbar.querySelectorAll(`.${e}-btn`).forEach(t=>{t.classList.remove(`${e}-btn-disabled`),"codeView"===t.dataset.command&&t.classList.remove(`${e}-btn-active`)}))}showTableModal(){const e=this.config.classPrefix,t=this.config.tableDefaults;this.saveSelection();const o=`\n            <div class="${e}-modal-header">Insert Table</div>\n            <div class="${e}-modal-body">\n                <div class="${e}-modal-row">\n                    <label class="${e}-modal-label">Rows</label>\n                    <input type="number" class="${e}-modal-input" id="${e}-table-rows" value="${t.rows}" min="1" max="20">\n                </div>\n                <div class="${e}-modal-row">\n                    <label class="${e}-modal-label">Columns</label>\n                    <input type="number" class="${e}-modal-input" id="${e}-table-cols" value="${t.cols}" min="1" max="20">\n                </div>\n            </div>\n            <div class="${e}-modal-footer">\n                <button type="button" class="${e}-modal-btn ${e}-modal-btn-secondary" data-action="cancel">Cancel</button>\n                <button type="button" class="${e}-modal-btn ${e}-modal-btn-primary" data-action="insert">Insert</button>\n            </div>\n        `;this.showModal(o,o=>{const n=parseInt(o.querySelector(`#${e}-table-rows`).value,10)||t.rows,i=parseInt(o.querySelector(`#${e}-table-cols`).value,10)||t.cols;this.insertTable(n,i)})}insertTable(e,t){let o="<table><tbody>";for(let n=0;n<e;n++){o+="<tr>";for(let e=0;e<t;e++)o+="<td>&nbsp;</td>";o+="</tr>"}o+="</tbody></table>",this.restoreSelection(),document.execCommand("insertHTML",!1,o),this.sync()}showImageModal(){const e=this.config.classPrefix;this.saveSelection();let t=`\n            <div class="${e}-modal-header">Insert Image</div>\n            <div class="${e}-modal-body">\n        `;this.config.imageUpload?t+=`\n                <div class="${e}-modal-tabs">\n                    <div class="${e}-modal-tab ${e}-modal-tab-active" data-tab="url">URL</div>\n                    <div class="${e}-modal-tab" data-tab="upload">Upload</div>\n                </div>\n                <div class="${e}-modal-tab-content ${e}-modal-tab-content-active" data-tab-content="url">\n                    <div class="${e}-modal-row">\n                        <label class="${e}-modal-label">Image URL</label>\n                        <input type="url" class="${e}-modal-input" id="${e}-image-url" placeholder="https://example.com/image.jpg">\n                    </div>\n                </div>\n                <div class="${e}-modal-tab-content" data-tab-content="upload">\n                    <div class="${e}-modal-row">\n                        <label class="${e}-modal-label">Select Image</label>\n                        <input type="file" class="${e}-modal-input" id="${e}-image-file" accept="${this.config.allowedImageTypes.join(",")}">\n                    </div>\n                </div>\n            `:t+=`\n                <div class="${e}-modal-row">\n                    <label class="${e}-modal-label">Image URL</label>\n                    <input type="url" class="${e}-modal-input" id="${e}-image-url" placeholder="https://example.com/image.jpg">\n                </div>\n            `,t+=`\n                <div class="${e}-modal-row">\n                    <label class="${e}-modal-label">Alt Text</label>\n                    <input type="text" class="${e}-modal-input" id="${e}-image-alt" placeholder="Image description">\n                </div>\n            </div>\n            <div class="${e}-modal-footer">\n                <button type="button" class="${e}-modal-btn ${e}-modal-btn-secondary" data-action="cancel">Cancel</button>\n                <button type="button" class="${e}-modal-btn ${e}-modal-btn-primary" data-action="insert">Insert</button>\n            </div>\n        `,this.showModal(t,t=>{const o=t.querySelector(`#${e}-image-url`),n=t.querySelector(`#${e}-image-file`),i=t.querySelector(`#${e}-image-alt`).value||"",a=t.querySelector(`.${e}-modal-tab-active`);a&&"upload"===a.dataset.tab&&n&&n.files.length>0?this.insertImageFromFile(n.files[0],i):o&&o.value&&this.insertImageFromUrl(o.value,i)},t=>{const o=t.querySelectorAll(`.${e}-modal-tab`);o.forEach(n=>{n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),o.forEach(t=>t.classList.remove(`${e}-modal-tab-active`)),n.classList.add(`${e}-modal-tab-active`);const a=n.dataset.tab;t.querySelectorAll(`.${e}-modal-tab-content`).forEach(t=>{t.classList.remove(`${e}-modal-tab-content-active`)}),t.querySelector(`[data-tab-content="${a}"]`).classList.add(`${e}-modal-tab-content-active`)})})})}insertImageFromUrl(e,t=""){const o=`<img src="${this.escapeHtml(e)}" alt="${this.escapeHtml(t)}">`;this.restoreSelection(),document.execCommand("insertHTML",!1,o),this.sync()}insertImageFromFile(e,t=""){if(!this.config.allowedImageTypes.includes(e.type))return void alert("Invalid image type. Allowed: "+this.config.allowedImageTypes.join(", "));if(e.size>this.config.maxImageSize){const e=Math.round(this.config.maxImageSize/1024/1024);return void alert(`Image too large. Maximum size: ${e}MB`)}const o=new FileReader;o.onload=e=>{const o=`<img src="${e.target.result}" alt="${this.escapeHtml(t)}">`;this.restoreSelection(),document.execCommand("insertHTML",!1,o),this.sync()},o.readAsDataURL(e)}showModal(e,t,o=null){const n=this.config.classPrefix,i=document.createElement("div");i.className=`${n}-modal-overlay`;const a=document.createElement("div");a.className=`${n}-modal`,a.innerHTML=e,i.appendChild(a);const s=this.wrapper.closest(".modal");s?s.appendChild(i):document.body.appendChild(i),a.querySelectorAll("input, textarea").forEach(e=>{["click","mousedown","mouseup","focus","keydown","keyup","keypress","input"].forEach(t=>{e.addEventListener(t,e=>e.stopPropagation())})}),a.addEventListener("mousedown",e=>e.stopPropagation()),o&&o(a);const l=a.querySelector("input");l&&l.focus(),a.addEventListener("click",e=>{const o=e.target.closest("[data-action]");if(!o)return;const n=o.dataset.action;"cancel"===n?this.closeModal(i):"insert"===n&&(t(a),this.closeModal(i))});const r=e=>{"Escape"===e.key&&(this.closeModal(i),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),i.addEventListener("click",e=>{e.target===i&&this.closeModal(i)})}closeModal(e){e.remove()}selectImage(e){this.deselectImage();const t=this.config.classPrefix;this.selectedImage=e,e.classList.add(`${t}-image-selected`),this.showImageToolbar(e),this.showImageResizer(e)}deselectImage(){if(!this.selectedImage)return;const e=this.config.classPrefix;this.selectedImage.classList.remove(`${e}-image-selected`),this.selectedImage=null,this.imageToolbar&&(this.imageToolbar.remove(),this.imageToolbar=null),this.imageResizer&&(this.imageResizer.remove(),this.imageResizer=null)}showImageToolbar(e){const t=this.config.classPrefix;this.imageToolbar=document.createElement("div"),this.imageToolbar.className=`${t}-image-toolbar`,this.imageToolbar.innerHTML=`\n            <button type="button" class="${t}-image-toolbar-btn" data-action="edit-alt" title="Edit alt text">Alt</button>\n            <button type="button" class="${t}-image-toolbar-btn" data-action="resize-50" title="50% size">50%</button>\n            <button type="button" class="${t}-image-toolbar-btn" data-action="resize-100" title="Original size">100%</button>\n            <button type="button" class="${t}-image-toolbar-btn" data-action="delete" title="Delete image">&#10060;</button>\n        `,this.wrapper.appendChild(this.imageToolbar),this.updateToolbarPosition(e),this.imageToolbar.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const o=t.dataset.action;this.handleImageAction(o)})}showImageResizer(e){const t=this.config.classPrefix;this.imageResizer=document.createElement("div"),this.imageResizer.className=`${t}-image-resizer`,this.imageResizer.innerHTML=`\n            <div class="${t}-image-handle ${t}-image-handle-se" data-handle="se"></div>\n            <div class="${t}-image-handle ${t}-image-handle-sw" data-handle="sw"></div>\n            <div class="${t}-image-handle ${t}-image-handle-ne" data-handle="ne"></div>\n            <div class="${t}-image-handle ${t}-image-handle-nw" data-handle="nw"></div>\n        `,this.updateResizerPosition(e),this.imageResizer.querySelectorAll("[data-handle]").forEach(e=>{e.addEventListener("mousedown",t=>this.startImageResize(t,e.dataset.handle))}),this.wrapper.appendChild(this.imageResizer)}updateResizerPosition(e){if(!this.imageResizer)return;let t=e.offsetLeft,o=e.offsetTop,n=e.offsetParent;for(;n&&n!==this.editor;)t+=n.offsetLeft,o+=n.offsetTop,n=n.offsetParent;t+=this.editor.offsetLeft,o+=this.editor.offsetTop,this.imageResizer.style.left=`${t}px`,this.imageResizer.style.top=`${o}px`,this.imageResizer.style.width=`${e.offsetWidth}px`,this.imageResizer.style.height=`${e.offsetHeight}px`}startImageResize(e,t){if(!this.selectedImage)return;e.preventDefault(),e.stopPropagation();const o=this.selectedImage,n=e.clientX,i=e.clientY,a=o.offsetWidth,s=o.offsetHeight,l=a/s,r=e=>{let s=e.clientX-n,r=e.clientY-i;"nw"!==t&&"sw"!==t||(s=-s),"nw"!==t&&"ne"!==t||(r=-r);let d=a+s,c=d/l;d<50&&(d=50,c=d/l),o.style.width=`${Math.round(d)}px`,o.style.height="auto",this.updateResizerPosition(o),this.updateToolbarPosition(o)},d=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",d),this.sync()};document.addEventListener("mousemove",r),document.addEventListener("mouseup",d)}updateToolbarPosition(e){if(!this.imageToolbar)return;let t=e.offsetLeft,o=e.offsetTop,n=e.offsetParent;for(;n&&n!==this.editor;)t+=n.offsetLeft,o+=n.offsetTop,n=n.offsetParent;t+=this.editor.offsetLeft,o+=this.editor.offsetTop,this.imageToolbar.style.left=`${t}px`,this.imageToolbar.style.top=o-36+"px"}handleImageAction(e){if(!this.selectedImage)return;const t=this.selectedImage;switch(e){case"edit-alt":this.editImageAlt(t);break;case"resize-50":t.style.width="50%",t.style.height="auto",this.updateResizerPosition(t),this.updateToolbarPosition(t),this.sync();break;case"resize-100":t.style.width="",t.style.height="",this.updateResizerPosition(t),this.updateToolbarPosition(t),this.sync();break;case"delete":this.deleteImage(t)}}editImageAlt(e){const t=this.config.classPrefix,o=e.alt||"",n=`\n            <div class="${t}-modal-header">Edit Alt Text</div>\n            <div class="${t}-modal-body">\n                <div class="${t}-modal-row">\n                    <label class="${t}-modal-label">Alt Text</label>\n                    <input type="text" class="${t}-modal-input" id="${t}-edit-alt" value="${this.escapeHtml(o)}" placeholder="Image description">\n                </div>\n            </div>\n            <div class="${t}-modal-footer">\n                <button type="button" class="${t}-modal-btn ${t}-modal-btn-secondary" data-action="cancel">Cancel</button>\n                <button type="button" class="${t}-modal-btn ${t}-modal-btn-primary" data-action="insert">Save</button>\n            </div>\n        `;this.showModal(n,o=>{const n=o.querySelector(`#${t}-edit-alt`).value;e.alt=n,this.sync()})}deleteImage(e){this.deselectImage(),e.remove(),this.sync()}selectTable(e,t=null){this.deselectTable();const o=this.config.classPrefix;this.selectedTable=e,this.selectedCell=t,e.classList.add(`${o}-table-selected`),this.showTableToolbar(e)}deselectTable(){if(!this.selectedTable)return;const e=this.config.classPrefix;this.selectedTable.classList.remove(`${e}-table-selected`),this.selectedTable=null,this.selectedCell=null,this.tableToolbar&&(this.tableToolbar.remove(),this.tableToolbar=null)}showTableToolbar(e){const t=this.config.classPrefix;this.tableToolbar=document.createElement("div"),this.tableToolbar.className=`${t}-table-toolbar`,this.tableToolbar.innerHTML=`\n            <button type="button" class="${t}-table-toolbar-btn" data-action="properties" title="Table properties">&#9881; Properties</button>\n            <span class="${t}-table-toolbar-separator"></span>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="row-above" title="Insert row above">&#8593; Row</button>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="row-below" title="Insert row below">&#8595; Row</button>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="col-left" title="Insert column left">&#8592; Col</button>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="col-right" title="Insert column right">&#8594; Col</button>\n            <span class="${t}-table-toolbar-separator"></span>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="delete-row" title="Delete row">&#10060; Row</button>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="delete-col" title="Delete column">&#10060; Col</button>\n            <button type="button" class="${t}-table-toolbar-btn" data-action="delete-table" title="Delete table">&#10060; Table</button>\n        `,this.wrapper.appendChild(this.tableToolbar),this.updateTableToolbarPosition(e),this.tableToolbar.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const o=t.dataset.action;this.handleTableAction(o)})}updateTableToolbarPosition(e){if(!this.tableToolbar)return;let t=e.offsetLeft,o=e.offsetTop,n=e.offsetParent;for(;n&&n!==this.editor;)t+=n.offsetLeft,o+=n.offsetTop,n=n.offsetParent;t+=this.editor.offsetLeft,o+=this.editor.offsetTop,this.tableToolbar.style.left=`${t}px`,this.tableToolbar.style.top=o-this.tableToolbar.offsetHeight-5+"px"}handleTableAction(e){const t=this.selectedTable,o=this.selectedCell;if(t)switch(e){case"properties":this.showTablePropertiesModal(t);break;case"row-above":this.insertTableRow(t,o,"above");break;case"row-below":this.insertTableRow(t,o,"below");break;case"col-left":this.insertTableColumn(t,o,"left");break;case"col-right":this.insertTableColumn(t,o,"right");break;case"delete-row":this.deleteTableRow(t,o);break;case"delete-col":this.deleteTableColumn(t,o);break;case"delete-table":this.deleteTable(t)}}showTablePropertiesModal(e){const t=this.config.classPrefix,o=(window.getComputedStyle(e),e.querySelectorAll("td, th")[0]),n=o?window.getComputedStyle(o):null;let i="1",a="#cccccc",s="8",l="100";if(n){const e=n.borderWidth.match(/(\d+)/);e&&(i=e[1]),a=this.rgbToHex(n.borderColor)||"#cccccc";const t=n.padding.match(/(\d+)/);t&&(s=t[1])}if(e.style.width){const t=e.style.width.match(/(\d+)/);t&&(l=t[1])}const r=`\n            <div class="${t}-modal-header">Table Properties</div>\n            <div class="${t}-modal-body">\n                <div class="${t}-modal-row">\n                    <label class="${t}-modal-label">Border Width (px)</label>\n                    <input type="number" class="${t}-modal-input" id="${t}-table-border" value="${i}" min="0" max="10">\n                </div>\n                <div class="${t}-modal-row">\n                    <label class="${t}-modal-label">Border Color</label>\n                    <input type="color" class="${t}-modal-input" id="${t}-table-border-color" value="${a}" style="height: 36px; padding: 2px;">\n                </div>\n                <div class="${t}-modal-row">\n                    <label class="${t}-modal-label">Cell Padding (px)</label>\n                    <input type="number" class="${t}-modal-input" id="${t}-table-padding" value="${s}" min="0" max="50">\n                </div>\n                <div class="${t}-modal-row">\n                    <label class="${t}-modal-label">Table Width (%)</label>\n                    <input type="number" class="${t}-modal-input" id="${t}-table-width" value="${l}" min="10" max="100">\n                </div>\n            </div>\n            <div class="${t}-modal-footer">\n                <button type="button" class="${t}-modal-btn ${t}-modal-btn-secondary" data-action="cancel">Cancel</button>\n                <button type="button" class="${t}-modal-btn ${t}-modal-btn-primary" data-action="insert">Apply</button>\n            </div>\n        `;this.showModal(r,o=>{const n=o.querySelector(`#${t}-table-border`).value,i=o.querySelector(`#${t}-table-border-color`).value,a=o.querySelector(`#${t}-table-padding`).value,s=o.querySelector(`#${t}-table-width`).value;this.applyTableProperties(e,{borderWidth:parseInt(n,10),borderColor:i,cellPadding:parseInt(a,10),tableWidth:parseInt(s,10)})})}applyTableProperties(e,t){const{borderWidth:o,borderColor:n,cellPadding:i,tableWidth:a}=t;e.style.width=`${a}%`;e.querySelectorAll("td, th").forEach(e=>{e.style.border=`${o}px solid ${n}`,e.style.padding=`${i}px`}),this.sync()}rgbToHex(e){const t=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(!t)return null;return`#${parseInt(t[1],10).toString(16).padStart(2,"0")}${parseInt(t[2],10).toString(16).padStart(2,"0")}${parseInt(t[3],10).toString(16).padStart(2,"0")}`}insertTableRow(e,t,o){const n=t?t.closest("tr"):e.querySelector("tr");if(!n)return;const i=n.cells.length,a=document.createElement("tr");for(let e=0;e<i;e++){const e=document.createElement("td");e.innerHTML="&nbsp;";const t=n.cells[0];t&&(e.style.border=t.style.border||"",e.style.padding=t.style.padding||""),a.appendChild(e)}"above"===o?n.parentNode.insertBefore(a,n):n.parentNode.insertBefore(a,n.nextSibling),this.sync()}insertTableColumn(e,t,o){const n=t?t.cellIndex:0;e.querySelectorAll("tr").forEach(e=>{const t=e.cells[n];if(!t)return;const i="TH"===t.tagName,a=document.createElement(i?"th":"td");a.innerHTML="&nbsp;",a.style.border=t.style.border||"",a.style.padding=t.style.padding||"","left"===o?e.insertBefore(a,t):e.insertBefore(a,t.nextSibling)}),this.sync()}deleteTableRow(e,t){const o=t?t.closest("tr"):null;o&&(e.querySelectorAll("tr").length<=1||(o.remove(),this.sync()))}deleteTableColumn(e,t){if(!t)return;const o=t.cellIndex,n=e.querySelectorAll("tr"),i=n[0];i&&i.cells.length<=1||(n.forEach(e=>{e.cells[o]&&e.cells[o].remove()}),this.sync())}deleteTable(e){this.deselectTable(),e.remove(),this.sync()}handleKeyboard(e){if(!this.config.shortcuts)return;if(!(navigator.platform.includes("Mac")?e.metaKey:e.ctrlKey))return;const t={b:"bold",i:"italic",u:"underline"},o=e.key.toLowerCase();return"k"===o?(e.preventDefault(),void this.insertLink()):e.shiftKey&&"z"===o?(e.preventDefault(),void this.exec("redo")):void(t[o]&&(e.preventDefault(),this.exec(t[o])))}handlePaste(e){if(this.config.pasteAsPlainText){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain");return document.execCommand("insertText",!1,t),void this.sync()}setTimeout(()=>{this.sanitizeContent(),this.sync()},0)}sanitizeContent(){this.editor.querySelectorAll("script, style, link, meta, iframe, object, embed").forEach(e=>e.remove()),this.editor.querySelectorAll("*").forEach(e=>{[...e.attributes].forEach(t=>{t.name.startsWith("on")&&e.removeAttribute(t.name)})})}normalizeContent(){let e=!0,t=0;for(;e&&t<10;)e=!1,t++,this.editor.querySelectorAll("div").forEach(t=>{const o=t.querySelector(":scope > ul, :scope > ol, :scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5, :scope > h6, :scope > blockquote, :scope > p");if(o&&1===t.children.length&&t.textContent.trim()===o.textContent.trim())return t.replaceWith(o),void(e=!0);if(t.querySelector("div, p, ul, ol, h1, h2, h3, h4, h5, h6, blockquote"))return;const n=document.createElement("p");n.innerHTML=t.innerHTML,t.replaceWith(n),e=!0})}updateToolbarState(){const e=this.toolbar.querySelectorAll("[data-command]"),t=`${this.config.classPrefix}-btn-active`;e.forEach(e=>{const o=e.dataset.command,n=e.dataset.value;if(e.classList.remove(t),"formatBlock"===o&&n){document.queryCommandValue("formatBlock").toLowerCase()===n.toLowerCase()&&e.classList.add(t)}else if("subscript"===o)this.isInsideTag("sub")&&e.classList.add(t);else if("superscript"===o)this.isInsideTag("sup")&&e.classList.add(t);else if("justifyFull"===o){const o=this.getSelectedBlockElement();o&&"justify"===getComputedStyle(o).textAlign&&e.classList.add(t)}else try{document.queryCommandState(o)&&e.classList.add(t)}catch(e){}})}getCleanContent(){const e=this.config.classPrefix,t=this.editor.cloneNode(!0);return t.querySelectorAll(`.${e}-image-toolbar, .${e}-image-resizer, .${e}-table-toolbar`).forEach(e=>e.remove()),t.querySelectorAll(`.${e}-image-selected`).forEach(t=>t.classList.remove(`${e}-image-selected`)),t.querySelectorAll(`.${e}-table-selected`).forEach(t=>t.classList.remove(`${e}-table-selected`)),t.innerHTML}sanitizeEditorUI(e){const t=this.config.classPrefix,o=document.createElement("div");return o.innerHTML=e,o.querySelectorAll(`.${t}-image-toolbar, .${t}-image-resizer, .${t}-table-toolbar`).forEach(e=>e.remove()),o.querySelectorAll(`.${t}-image-selected`).forEach(e=>e.classList.remove(`${t}-image-selected`)),o.querySelectorAll(`.${t}-table-selected`).forEach(e=>e.classList.remove(`${t}-table-selected`)),o.innerHTML}sync(){this.normalizeContent(),this.textarea.value=this.getCleanContent()}getContent(){return this.getCleanContent()}setContent(e){this.editor.innerHTML=this.sanitizeEditorUI(e),this.sync()}getText(){return this.editor.textContent||this.editor.innerText}focus(){this.editor.focus()}blur(){this.editor.blur()}isEmpty(){return 0===this.getText().trim().length}destroy(){this.documentClickHandler&&(document.removeEventListener("click",this.documentClickHandler),this.documentClickHandler=null),this.deselectImage(),this.wrapper.parentNode.insertBefore(this.textarea,this.wrapper),this.textarea.style.display="",this.wrapper.remove(),this.wrapper=null,this.toolbar=null,this.editor=null,this.codeEditor=null,this.savedSelection=null,this.selectedImage=null,this.imageToolbar=null,this.imageResizer=null}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}
/**
     * Factory method to create editor instances
     *
     * @param {string} selector - CSS selector for textarea(s)
     * @param {Object} options - Configuration options
     * @returns {WYSIWYGEditor|WYSIWYGEditor[]} Single editor or array of editors
     */static init(e,t={}){const o=document.querySelectorAll(e);if(0===o.length)throw new Error(`No elements found for selector: ${e}`);return 1===o.length?new WYSIWYGEditor(o[0],t):Array.from(o).map(e=>new WYSIWYGEditor(e,t))}}"undefined"!=typeof module&&module.exports&&(module.exports=WYSIWYGEditor);